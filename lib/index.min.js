!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasSelect=e()}(this,(function(){"use strict";function t(t,e,i){let s=!1;const h=i.length;for(let a=0,n=h-1;a<h;n=a++){const h=i[a][0],o=i[a][1],c=i[n][0],l=i[n][1];o>e!=l>e&&t<(c-h)*(e-o)/(l-o)+h&&(s=!s)}return s}let e=class{constructor(t,e){this.label="",this.hideLabel=!1,this.coor=[],this.strokeStyle="#000",this.fillStyle="#fff",this.lineWidth=1,this.labelFillStyle="#000",this.textFillStyle="#fff",this.labelFont="14px Microsoft YaHei",this.type=1,this.active=!1,this.creating=!1,this.dragging=!1,this.uuid=function(){const t=[],e="0123456789abcdef";for(let i=0;i<36;i++){const s=Math.floor(16*Math.random());t[i]=e.slice(s,s+1)}t[14]="4";const i=3&t[19]|8;return t[19]=e.slice(i,i+1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}(),this.labelUp=!1,this.index=e,Object.assign(this,t)}};class i extends e{constructor(t,e){super(t,e),this.type=1}get ctrlsData(){const[[t,e],[i,s]]=this.coor;return[[t,e],[t+(i-t)/2,e],[i,e],[i,e+(s-e)/2],[i,s],[t+(i-t)/2,s],[t,s],[t,e+(s-e)/2]]}}class s extends e{constructor(t,e){super(t,e),this.type=2}get ctrlsData(){return this.coor.length>2?this.coor:[]}}class h extends e{constructor(t,e){super(t,e),this.type=3}}class a{constructor(){this._eventTree={}}on(t,e){const i=this._eventTree[t];Array.isArray(i)?i.push(e):this._eventTree[t]=[e]}emit(t,...e){const i=this._eventTree[t];Array.isArray(i)&&i.forEach((t=>t(...e)))}off(t,e){const i=this._eventTree[t],s=i.find((t=>t===e));Array.isArray(i)&&s&&i.splice(s,1)}}class n extends e{constructor(t,e){super(t,e),this.type=4}get ctrlsData(){return this.coor.length>1?this.coor:[]}}class o extends e{constructor(t,e){super(t,e),this.type=5,this.radius=0,this.radius=t.radius||this.radius}get ctrlsData(){const[t,e]=this.coor;return[[t,e-this.radius],[t+this.radius,e],[t,e+this.radius],[t-this.radius,e]]}}var c;!function(t){t[t.None=0]="None",t[t.Rect=1]="Rect",t[t.Polygon=2]="Polygon",t[t.Dot=3]="Dot",t[t.Line=4]="Line",t[t.Circle=5]="Circle"}(c||(c={}));return class extends a{constructor(t,e){super(),this.lock=!1,this.readonly=!1,this.MIN_WIDTH=10,this.MIN_HEIGHT=10,this.MIN_RADIUS=5,this.strokeStyle="#0f0",this.fillStyle="rgba(0, 0, 255,0.1)",this.lineWidth=1,this.activeStrokeStyle="#f00",this.activeFillStyle="rgba(255, 0, 0,0.1)",this.ctrlStrokeStyle="#000",this.ctrlFillStyle="#fff",this.ctrlRadius=3,this.hideLabel=!1,this.labelFillStyle="#fff",this.labelFont="10px sans-serif",this.textFillStyle="#000",this.labelMaxLen=10,this.WIDTH=0,this.HEIGHT=0,this.dataset=[],this.remmber=[],this.mouse=[0,0],this.remmberOrigin=[0,0],this.createType=c.None,this.ctrlIndex=-1,this.image=new Image,this.IMAGE_ORIGIN_WIDTH=0,this.IMAGE_WIDTH=0,this.IMAGE_ORIGIN_HEIGHT=0,this.IMAGE_HEIGHT=0,this.originX=0,this.originY=0,this.scaleStep=0,this.scrollZoom=!0,this.dblTouch=300,this.dblTouchStore=0,this.alpha=!0,this.focusMode=!1,this.evt=null,this.scaleTouchStore=0,this.isTouch2=!1,this.isMobile=navigator.userAgent.includes("Mobile"),this.labelUp=!1,this.ctrlKey=!1,this.handleLoad=this.handleLoad.bind(this),this.handleContextmenu=this.handleContextmenu.bind(this),this.handleMousewheel=this.handleMousewheel.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleDblclick=this.handleDblclick.bind(this),this.handleKeyup=this.handleKeyup.bind(this),this.handleKeydown=this.handleKeydown.bind(this);const i="string"==typeof t?document.querySelector(t):t;i instanceof HTMLCanvasElement?(this.canvas=i,this.offScreen=document.createElement("canvas"),this.initSetting(),this.initEvents(),e&&this.setImage(e)):console.warn("HTMLCanvasElement is required!")}get activeShape(){return this.dataset.find((t=>t.active))||{}}get scale(){return this.IMAGE_ORIGIN_WIDTH&&this.IMAGE_WIDTH?this.IMAGE_WIDTH/this.IMAGE_ORIGIN_WIDTH:1}get imageMin(){return Math.min(this.IMAGE_WIDTH,this.IMAGE_HEIGHT)}get imageOriginMax(){return Math.max(this.IMAGE_ORIGIN_WIDTH,this.IMAGE_ORIGIN_HEIGHT)}mergeEvent(t){let e=0,i=0,s=0,h=0;if(this.isMobile){const{clientX:a,clientY:n}=t.touches[0],o=t.target,{left:c,top:l}=o.getBoundingClientRect();if(e=Math.round(a-c),i=Math.round(n-l),2===t.touches.length){const{clientX:e=0,clientY:i=0}=t.touches[1]||{};s=Math.round(Math.abs((e-a)/2+a)-c),h=Math.round(Math.abs((i-n)/2+n)-l)}}else e=t.offsetX,i=t.offsetY;return Object.assign(Object.assign({},t),{mouseX:e,mouseY:i,mouseCX:s,mouseCY:h})}handleLoad(){this.emit("load",this.image.src),this.IMAGE_ORIGIN_WIDTH=this.IMAGE_WIDTH=this.image.width,this.IMAGE_ORIGIN_HEIGHT=this.IMAGE_HEIGHT=this.image.height,this.fitZoom()}handleContextmenu(t){t.preventDefault(),this.evt=t,this.lock}handleMousewheel(t){if(t.stopPropagation(),this.evt=t,this.lock||!this.scrollZoom)return;const{mouseX:e,mouseY:i}=this.mergeEvent(t);this.mouse=[e,i],this.setScale(t.deltaY<0,!0)}handleMouseDown(t){if(t.stopPropagation(),this.evt=t,this.lock)return;const{mouseX:e,mouseY:a,mouseCX:l,mouseCY:r}=this.mergeEvent(t),d=Math.round(e/this.scale),u=Math.round(a/this.scale);if(this.mouse=this.isMobile&&2===t.touches.length?[l,r]:[e,a],this.remmberOrigin=[e-this.originX,a-this.originY],!this.isMobile&&1===t.buttons||this.isMobile&&1===t.touches.length){const e=this.activeShape.ctrlsData||[];if(this.ctrlIndex=e.findIndex((t=>this.isPointInCircle(this.mouse,t,this.ctrlRadius))),this.ctrlIndex>-1&&!this.readonly){const[i,s]=e[this.ctrlIndex];this.activeShape.type===c.Polygon&&this.activeShape.coor.length>2&&0===this.ctrlIndex&&this.handleDblclick(t),this.remmber=[[d-i,u-s]]}else if(this.isInBackground(t)){if(this.activeShape.creating&&!this.readonly){if([c.Polygon,c.Line].includes(this.activeShape.type)){const[t,e]=this.activeShape.coor[this.activeShape.coor.length-1];if(t!==d&&e!==u){const t=Math.round(d-this.originX/this.scale),e=Math.round(u-this.originY/this.scale);this.activeShape.coor.push([t,e])}}}else if(this.createType===c.None||this.readonly||this.ctrlKey){const[t,e]=this.hitOnShape(this.mouse);if(t>-1){if(e.dragging=!0,this.dataset.forEach(((e,i)=>e.active=i===t)),this.dataset.splice(t,1),this.dataset.push(e),!this.readonly)if(this.remmber=[],[c.Dot,c.Circle].includes(e.type)){const[t,i]=e.coor;this.remmber=[[d-t,u-i]]}else e.coor.forEach((t=>{this.remmber.push([d-t[0],u-t[1]])}));this.emit("select",e)}else this.activeShape.active=!1,this.dataset.sort(((t,e)=>t.index-e.index)),this.emit("select",null)}else{let t;const e=[Math.round(d-this.originX/this.scale),Math.round(u-this.originY/this.scale)];switch(this.createType){case c.Rect:t=new i({coor:[e,e]},this.dataset.length),t.creating=!0;break;case c.Polygon:t=new s({coor:[e]},this.dataset.length),t.creating=!0;break;case c.Dot:t=new h({coor:e},this.dataset.length),this.emit("add",t);break;case c.Line:t=new n({coor:[e]},this.dataset.length),t.creating=!0;break;case c.Circle:t=new o({coor:e},this.dataset.length),t.creating=!0}this.dataset.forEach((t=>{t.active=!1})),t.active=!0,this.dataset.push(t)}this.update()}}}handleMouseMove(t){if(t.stopPropagation(),this.evt=t,this.lock)return;const{mouseX:e,mouseY:i,mouseCX:s,mouseCY:h}=this.mergeEvent(t),a=Math.round(e/this.scale),n=Math.round(i/this.scale);if(this.mouse=this.isMobile&&2===t.touches.length?[s,h]:[e,i],(!this.isMobile&&1===t.buttons||this.isMobile&&1===t.touches.length)&&this.activeShape.type){if(this.ctrlIndex>-1&&this.remmber.length&&(this.isInBackground(t)||this.activeShape.type===c.Circle)){const[[t,e]]=this.remmber;if(this.activeShape.type===c.Rect){const[[i,s],[h,o]]=this.activeShape.coor;let c=[];switch(this.ctrlIndex){case 0:c=[[a-t,n-e],[h,o]];break;case 1:c=[[i,n-e],[h,o]];break;case 2:c=[[i,n-e],[a-t,o]];break;case 3:c=[[i,s],[a-t,o]];break;case 4:c=[[i,s],[a-t,n-e]];break;case 5:c=[[i,s],[h,n-e]];break;case 6:c=[[a-t,s],[h,n-e]];break;case 7:c=[[a-t,s],[h,o]]}let[[l,r],[d,u]]=c;(l<0||d<0||r<0||u<0||d>this.IMAGE_ORIGIN_WIDTH||u>this.IMAGE_ORIGIN_HEIGHT)&&(l<0&&(l=0),d<0&&(d=0),r<0&&(r=0),u<0&&(u=0),d>this.IMAGE_ORIGIN_WIDTH&&(d=this.IMAGE_ORIGIN_WIDTH),u>this.IMAGE_ORIGIN_HEIGHT&&(u=this.IMAGE_ORIGIN_HEIGHT)),d-l>=this.MIN_WIDTH&&u-r>=this.MIN_HEIGHT?this.activeShape.coor=[[l,r],[d,u]]:this.emit("warn",`Width cannot be less than ${this.MIN_WIDTH},Height cannot be less than${this.MIN_HEIGHT}ã€‚`)}else if([c.Polygon,c.Line].includes(this.activeShape.type)){const t=[Math.round(a-this.originX/this.scale),Math.round(n-this.originY/this.scale)];this.activeShape.coor.splice(this.ctrlIndex,1,t)}else if(this.activeShape.type===c.Circle){const t=Math.round(a-this.originX/this.scale)-this.activeShape.coor[0];t>=this.MIN_RADIUS&&(this.activeShape.radius=t)}}else if(this.activeShape.dragging&&!this.readonly){let t=[],e=!0;const i=this.IMAGE_ORIGIN_WIDTH||this.WIDTH,s=this.IMAGE_ORIGIN_HEIGHT||this.HEIGHT;if([c.Dot,c.Circle].includes(this.activeShape.type)){const[h,o]=this.remmber[0],c=a-h,l=n-o;(c<0||c>i||l<0||l>s)&&(e=!1),t=[c,l]}else for(let h=0;h<this.activeShape.coor.length;h++){const o=this.remmber[h],c=a-o[0],l=n-o[1];(c<0||c>i||l<0||l>s)&&(e=!1),t.push([c,l])}e&&(this.activeShape.coor=t)}else if(this.activeShape.creating&&this.isInBackground(t)){const t=Math.round(a-this.originX/this.scale),e=Math.round(n-this.originY/this.scale);if(this.activeShape.type===c.Rect)this.activeShape.coor.splice(1,1,[t,e]);else if(this.activeShape.type===c.Circle){const[i,s]=this.activeShape.coor,h=Math.sqrt((i-t)**2+(s-e)**2);this.activeShape.radius=h}}this.update()}else if([c.Polygon,c.Line].includes(this.activeShape.type)&&this.activeShape.creating)this.update();else if(!this.isMobile&&2===t.buttons&&3===t.which||this.isMobile&&1===t.touches.length&&!this.isTouch2)this.originX=Math.round(e-this.remmberOrigin[0]),this.originY=Math.round(i-this.remmberOrigin[1]),this.update();else if(this.isMobile&&2===t.touches.length){this.isTouch2=!0;const e=t.touches[0],i=t.touches[1],s=this.scaleTouchStore;this.scaleTouchStore=Math.abs((i.clientX-e.clientX)*(i.clientY-e.clientY)),this.setScale(this.scaleTouchStore>s,!0)}}handleMouseUp(t){if(t.stopPropagation(),this.evt=t,!this.lock){if(this.isMobile){if(0===t.touches.length&&(this.isTouch2=!1),Date.now()-this.dblTouchStore<this.dblTouch)return void this.handleDblclick(t);this.dblTouchStore=Date.now()}if(this.remmber=[],this.activeShape.type!==c.None&&!this.ctrlKey&&(this.activeShape.dragging=!1,this.activeShape.creating)){if(this.activeShape.type===c.Rect){const[[t,e],[i,s]]=this.activeShape.coor;Math.abs(t-i)<this.MIN_WIDTH||Math.abs(e-s)<this.MIN_HEIGHT?(this.dataset.pop(),this.emit("warn",`Width cannot be less than ${this.MIN_WIDTH},Height cannot be less than ${this.MIN_HEIGHT}`)):(this.activeShape.coor=[[Math.min(t,i),Math.min(e,s)],[Math.max(t,i),Math.max(e,s)]],this.activeShape.creating=!1,this.emit("add",this.activeShape))}else this.activeShape.type===c.Circle&&(this.activeShape.radius<this.MIN_RADIUS?(this.dataset.pop(),this.emit("warn",`Radius cannot be less than ${this.MIN_WIDTH}`)):(this.activeShape.creating=!1,this.emit("add",this.activeShape)));this.update()}}}handleDblclick(t){if(t.stopPropagation(),this.evt=t,!this.lock&&[c.Polygon,c.Line].includes(this.activeShape.type)){const t=this.activeShape.type===c.Polygon&&this.activeShape.coor.length>2,e=this.activeShape.type===c.Line&&this.activeShape.coor.length>1;(t||e)&&(this.emit("add",this.activeShape),this.activeShape.creating=!1,this.update())}}handleKeydown(t){"Control"===t.key&&(this.ctrlKey=!0)}handleKeyup(t){"Control"===t.key&&(this.ctrlKey=!1),this.evt=t,this.lock||this.readonly||this.activeShape.type&&([c.Polygon,c.Line].includes(this.activeShape.type)&&"Escape"===t.key?(this.activeShape.coor.length>1&&this.activeShape.creating?this.activeShape.coor.pop():this.deleteByIndex(this.activeShape.index),this.update()):"Delete"===t.key&&this.deleteByIndex(this.activeShape.index))}initSetting(){const t=window.devicePixelRatio||1;this.canvas.style.userSelect="none",this.ctx=this.ctx||this.canvas.getContext("2d",{alpha:this.alpha}),this.WIDTH=Math.round(this.canvas.clientWidth),this.HEIGHT=Math.round(this.canvas.clientHeight),this.canvas.width=this.WIDTH*t,this.canvas.height=this.HEIGHT*t,this.canvas.style.width=this.WIDTH+"px",this.canvas.style.height=this.HEIGHT+"px",this.offScreen.width=this.WIDTH,this.offScreen.height=this.HEIGHT,this.offScreenCtx=this.offScreenCtx||this.offScreen.getContext("2d",{willReadFrequently:!0}),this.ctx.scale(t,t)}initEvents(){this.image.addEventListener("load",this.handleLoad),this.canvas.addEventListener("touchstart",this.handleMouseDown),this.canvas.addEventListener("touchmove",this.handleMouseMove),this.canvas.addEventListener("touchend",this.handleMouseUp),this.canvas.addEventListener("contextmenu",this.handleContextmenu),this.canvas.addEventListener("mousewheel",this.handleMousewheel),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("dblclick",this.handleDblclick),document.body.addEventListener("keydown",this.handleKeydown,!0),document.body.addEventListener("keyup",this.handleKeyup,!0)}setImage(t){this.image.src=t}setData(t){setTimeout((()=>{const e=[];t.forEach(((t,a)=>{if(Object.prototype.toString.call(t).includes("Object")){let l;switch(t.type){case c.Rect:l=new i(t,a);break;case c.Polygon:l=new s(t,a);break;case c.Dot:l=new h(t,a);break;case c.Line:l=new n(t,a);break;case c.Circle:l=new o(t,a);break;default:l=new i(t,a),console.warn("Invalid shape",t)}[c.Rect,c.Polygon,c.Dot,c.Line,c.Circle].includes(t.type)&&e.push(l)}else console.warn("Shape must be an enumerable Object.",t)})),this.dataset=e,this.update()}))}hitOnShape(t){let e,i=-1;for(let s=this.dataset.length-1;s>-1;s--){const h=this.dataset[s];if(h.type===c.Dot&&this.isPointInCircle(t,h.coor,this.ctrlRadius)||h.type===c.Circle&&this.isPointInCircle(t,h.coor,h.radius*this.scale)||h.type===c.Rect&&this.isPointInRect(t,h.coor)||h.type===c.Polygon&&this.isPointInPolygon(t,h.coor)||h.type===c.Line&&this.isPointInLine(t,h.coor)){if(this.focusMode&&!h.active)continue;i=s,e=h;break}}return[i,e]}isInBackground(t){const{mouseX:e,mouseY:i}=this.mergeEvent(t);return e>=this.originX&&i>=this.originY&&e<=this.originX+this.IMAGE_ORIGIN_WIDTH*this.scale&&i<=this.originY+this.IMAGE_ORIGIN_HEIGHT*this.scale}isPointInRect(t,e){const[i,s]=t,[[h,a],[n,o]]=e.map((t=>t.map((t=>t*this.scale))));return h+this.originX<=i&&i<=n+this.originX&&a+this.originY<=s&&s<=o+this.originY}isPointInPolygon(t,e){this.offScreenCtx.save(),this.offScreenCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offScreenCtx.translate(this.originX,this.originY),this.offScreenCtx.beginPath(),e.forEach(((t,e)=>{const[i,s]=t.map((t=>Math.round(t*this.scale)));0===e?this.offScreenCtx.moveTo(i,s):this.offScreenCtx.lineTo(i,s)})),this.offScreenCtx.closePath(),this.offScreenCtx.fill();const i=this.offScreenCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),s=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offScreenCtx.restore(),0!==i.data[s+3]}isPointInCircle(t,e,i){const[s,h]=t,[a,n]=e.map((t=>t*this.scale));return Math.sqrt((a+this.originX-s)**2+(n+this.originY-h)**2)<=i}isPointInLine(t,e){this.offScreenCtx.save(),this.offScreenCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offScreenCtx.translate(this.originX,this.originY),this.offScreenCtx.lineWidth=5,this.offScreenCtx.beginPath(),e.forEach(((t,e)=>{const[i,s]=t.map((t=>Math.round(t*this.scale)));0===e?this.offScreenCtx.moveTo(i,s):this.offScreenCtx.lineTo(i,s)})),this.offScreenCtx.stroke();const i=this.offScreenCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),s=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offScreenCtx.restore(),0!==i.data[s+3]}isNested(e,i){return function(e,i){if(1===e.type&&1===i.type){const[[t,s],[h,a]]=e.coor,[[n,o],[c,l]]=i.coor;return t<=n&&s<=o&&h>=c&&a>=l}if(1===e.type&&2===i.type){const[[t,s],[h,a]]=e.coor,n=i.coor;for(let e=0;e<n.length;e++){const[i,o]=n[e];if(i<t||i>h||o<s||o>a)return!1}return!0}if(2===e.type&&1===i.type){const s=i.coor;for(let i=0;i<s.length;i++){const[h,a]=s[i];if(!t(h,a,e.coor))return!1}return!0}if(2===e.type&&2===i.type){const s=e.coor,h=i.coor;for(let e=0;e<h.length;e++){const[i,a]=h[e];if(!t(i,a,s))return!1}return!0}return!1}(e,i)}drawRect(t){if(2!==t.coor.length)return;const{strokeStyle:e,fillStyle:i,active:s,creating:h,coor:a,lineWidth:n}=t,[[o,c],[l,r]]=a.map((t=>t.map((t=>Math.round(t*this.scale)))));this.ctx.save(),this.ctx.lineWidth=n||this.lineWidth,this.ctx.fillStyle=i||this.fillStyle,this.ctx.strokeStyle=s||h?this.activeStrokeStyle:e||this.strokeStyle;const d=l-o,u=r-c;h||this.ctx.fillRect(o,c,d,u),this.ctx.strokeRect(o,c,d,u),this.ctx.restore(),this.drawLabel(a[0],t)}drawPolygon(t){const{strokeStyle:e,fillStyle:i,active:s,creating:h,coor:a,lineWidth:n}=t;if(this.ctx.save(),this.ctx.lineJoin="round",this.ctx.lineWidth=n||this.lineWidth,this.ctx.fillStyle=i||this.fillStyle,this.ctx.strokeStyle=s||h?this.activeStrokeStyle:e||this.strokeStyle,this.ctx.beginPath(),a.forEach(((t,e)=>{const[i,s]=t.map((t=>Math.round(t*this.scale)));0===e?this.ctx.moveTo(i,s):this.ctx.lineTo(i,s)})),h){const[t,e]=this.mouse||[];this.ctx.lineTo(t-this.originX,e-this.originY)}else a.length>2&&this.ctx.closePath();this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(a[0],t)}drawDot(t){const{strokeStyle:e,fillStyle:i,active:s,coor:h,lineWidth:a}=t,[n,o]=h.map((t=>t*this.scale));this.ctx.save(),this.ctx.lineWidth=a||this.lineWidth,this.ctx.fillStyle=i||this.ctrlFillStyle,this.ctx.strokeStyle=s?this.activeStrokeStyle:e||this.strokeStyle,this.ctx.beginPath(),this.ctx.arc(n,o,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(n,o,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(h,t)}drawCirle(t){const{strokeStyle:e,fillStyle:i,active:s,coor:h,creating:a,radius:n,ctrlsData:o,lineWidth:c}=t,[l,r]=h.map((t=>t*this.scale));this.ctx.save(),this.ctx.lineWidth=c||this.lineWidth,this.ctx.fillStyle=i||this.fillStyle,this.ctx.strokeStyle=s||a?this.activeStrokeStyle:e||this.strokeStyle,this.ctx.beginPath(),this.ctx.arc(l,r,n*this.scale,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(l,r,n*this.scale,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore(),this.drawLabel(o[0],t)}drawLine(t){const{strokeStyle:e,active:i,creating:s,coor:h,lineWidth:a}=t;if(this.ctx.save(),this.ctx.lineJoin="round",this.ctx.lineWidth=a||this.lineWidth,this.ctx.strokeStyle=i||s?this.activeStrokeStyle:e||this.strokeStyle,this.ctx.beginPath(),h.forEach(((t,e)=>{const[i,s]=t.map((t=>Math.round(t*this.scale)));0===e?this.ctx.moveTo(i,s):this.ctx.lineTo(i,s)})),s){const[t,e]=this.mouse||[];this.ctx.lineTo(t-this.originX,e-this.originY)}this.ctx.stroke(),this.ctx.restore(),this.drawLabel(h[0],t)}drawCtrl(t){const[e,i]=t.map((t=>t*this.scale));this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=this.ctrlStrokeStyle,this.ctx.arc(e,i,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(e,i,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()}drawCtrlList(t){t.ctrlsData.forEach(((e,i)=>{t.type===c.Circle?1===i&&this.drawCtrl(e):this.drawCtrl(e)}))}drawLabel(t,e){const{label:i="",labelFillStyle:s="",labelFont:h="",textFillStyle:a="",hideLabel:n,labelUp:o,lineWidth:c}=e,l="boolean"==typeof n?n:this.hideLabel,r="boolean"==typeof o?o:this.labelUp,d=c||this.lineWidth;if(i.length&&!l){this.ctx.font=h||this.labelFont;const e=4,n=4,o=i.length<this.labelMaxLen+1?i:`${i.slice(0,this.labelMaxLen)}...`,c=this.ctx.measureText(o),l=parseInt(this.ctx.font)-4,u=c.width+2*e,I=l+2*n,[p,g]=t.map((t=>t*this.scale)),v=this.IMAGE_ORIGIN_WIDTH-t[0]<u/this.scale,f=this.IMAGE_ORIGIN_HEIGHT-t[1]<I/this.scale,S=t[1]>I/this.scale,y=r?S:f;this.ctx.save(),this.ctx.fillStyle=s||this.labelFillStyle,this.ctx.fillRect(v?p-c.width-e-d/2:p+d/2,y?g-I-d/2:g+d/2,u,I),this.ctx.fillStyle=a||this.textFillStyle,this.ctx.fillText(o,v?p-c.width:p+e+d/2,y?g-I+l+n:g+l+n+d/2,180),this.ctx.restore()}}update(){window.cancelAnimationFrame(this.timer),this.timer=window.requestAnimationFrame((()=>{this.ctx.save(),this.ctx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.ctx.translate(this.originX,this.originY),this.IMAGE_WIDTH&&this.IMAGE_HEIGHT&&this.ctx.drawImage(this.image,0,0,this.IMAGE_WIDTH,this.IMAGE_HEIGHT);const t=this.focusMode?this.activeShape.type?[this.activeShape]:[]:this.dataset;for(let e=0;e<t.length;e++){const i=t[e];if(!i.hide)switch(i.type){case c.Rect:this.drawRect(i);break;case c.Polygon:this.drawPolygon(i);break;case c.Dot:this.drawDot(i);break;case c.Line:this.drawLine(i);break;case c.Circle:this.drawCirle(i)}}[c.Rect,c.Polygon,c.Line,c.Circle].includes(this.activeShape.type)&&!this.activeShape.hide&&this.drawCtrlList(this.activeShape),this.ctx.restore(),this.emit("updated",this.dataset)}))}deleteByIndex(t){const e=this.dataset.findIndex((e=>e.index===t));e>-1&&(this.emit("delete",this.dataset[e]),this.dataset.splice(e,1),this.dataset.forEach(((t,e)=>{t.index=e})),this.update())}calcStep(t=""){this.IMAGE_WIDTH<this.WIDTH&&this.IMAGE_HEIGHT<this.HEIGHT&&(""!==t&&"b"!==t||(this.setScale(!0,!1,!0),this.calcStep("b"))),(this.IMAGE_WIDTH>this.WIDTH||this.IMAGE_HEIGHT>this.HEIGHT)&&(""!==t&&"s"!==t||(this.setScale(!1,!1,!0),this.calcStep("s")))}setScale(t,e=!1,i=!1){if(this.lock)return;if(!t&&this.imageMin<20||t&&this.IMAGE_WIDTH>100*this.imageOriginMax)return;t?this.scaleStep++:this.scaleStep--;let s=0,h=0;const[a,n]=this.mouse||[];e&&(s=(a-this.originX)/this.scale,h=(n-this.originY)/this.scale);const o=Math.abs(this.scaleStep),c=this.IMAGE_WIDTH;if(this.IMAGE_WIDTH=Math.round(this.IMAGE_ORIGIN_WIDTH*(this.scaleStep>=0?1.05:.95)**o),this.IMAGE_HEIGHT=Math.round(this.IMAGE_ORIGIN_HEIGHT*(this.scaleStep>=0?1.05:.95)**o),e)this.originX=a-s*this.scale,this.originY=n-h*this.scale;else{const t=this.IMAGE_WIDTH/c;this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*t,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*t}i||this.update()}fitZoom(){this.calcStep(),this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH)),this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2,this.update()}setFocusMode(t){this.focusMode=t,this.update()}destroy(){this.image.removeEventListener("load",this.handleLoad),this.canvas.removeEventListener("contextmenu",this.handleContextmenu),this.canvas.removeEventListener("mousewheel",this.handleMousewheel),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("touchend",this.handleMouseDown),this.canvas.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("touchmove",this.handleMouseMove),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("touchend",this.handleMouseUp),this.canvas.removeEventListener("dblclick",this.handleDblclick),document.body.removeEventListener("keydown",this.handleKeydown,!0),document.body.removeEventListener("keyup",this.handleKeyup,!0),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width=null,this.canvas.style.height=null,this.canvas.style.userSelect=null}resize(){this.canvas.width=null,this.canvas.height=null,this.canvas.style.width=null,this.canvas.style.height=null,this.initSetting(),this.update()}}}));
//# sourceMappingURL=index.min.js.map
